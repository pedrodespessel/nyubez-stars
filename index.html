<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Star Counter Duo</title>
  <style>
    html,body{
        margin:0;
        height:100%;
        display:flex;
        align-items:center;
        justify-content:center;
        font-family:"Segoe UI",sans-serif;
        background:#2f3437; /* Notion dark theme */
    }

    /* Wrapper com dois cards lado a lado */
    #wrapper{
      display:flex;gap:32px;flex-wrap:wrap;
      justify-content:center;align-items:flex-start;
    }

    /* Card base (4:3, bg, etc.) */
    .card{
      width:60vmin;height:calc(60vmin*0.75);
      max-width:480px;max-height:360px;
      background:url('background.png') center/cover no-repeat;
      border-radius:24px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      display:flex;align-items:center;justify-content:center;
      padding:24px;box-sizing:border-box;
    }

    .inner{
      display:flex;flex-direction:column;
      align-items:center;gap:16px;
    }

    .title{
      margin:0;font-size:24px;color:#fff;text-shadow:0 2px 4px #0007;
    }

    .starButton{
      font-size:18px;cursor:pointer;user-select:none;
      background:#ffeaa7;border:2px solid #dcdde1;
      padding:8px 16px;border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      transition:.2s;
    }
    .starButton:hover{background:#fdcb6e;transform:scale(1.05);}

    .star-row{display:flex;gap:8px;}
    .star{font-size:56px;line-height:1;}
    .empty{color:#b2bec3;}
    .filled{color:#facc15;}

    .cardsTxt{font-size:20px;font-weight:600;color:#333;}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <div id="wrapper">
    <!-- Card Bia -->
    <div id="card-bia" class="card">
      <div class="inner">
        <h2 class="title">Bia Stars</h2>
        <div id="bia-starButton" class="starButton">⭐ Dar estrela</div>
        <div class="star-row" id="bia-row1"></div>
        <div class="star-row" id="bia-row2"></div>
        <div class="cardsTxt">Cartelas: <span id="bia-cards">0</span></div>
      </div>
    </div>

    <!-- Card Pedro -->
    <div id="card-pedro" class="card">
      <div class="inner">
        <h2 class="title">Pedro Stars</h2>
        <div id="pedro-starButton" class="starButton">⭐ Dar estrela</div>
        <div class="star-row" id="pedro-row1"></div>
        <div class="star-row" id="pedro-row2"></div>
        <div class="cardsTxt">Cartelas: <span id="pedro-cards">0</span></div>
      </div>
    </div>
  </div>

<script>
  const supabase = window.supabase.createClient(
    'https://cvssyernxdxsymigsckq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2c3N5ZXJueGR4c3ltaWdzY2txIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzOTU5OTIsImV4cCI6MjA2NDk3MTk5Mn0.gauQlplTg-JjgFhYHkM1pbKVrEMU6-fMdiYQxFSs9T4'
  );

  const TABLE  = 'stars';
  const ROW_ID = 1;                   // única linha que guarda os contadores

  /** configuração dos dois cards */
  const cards = [
    { prefix: 'bia',   column: 'counter-bia' },
    { prefix: 'pedro', column: 'counter-pedro' }
  ];

  /* ---------- helpers ---------- */
  function buildStars (pref) {
    for (let i = 0; i < 10; i++) {
      const span   = document.createElement('span');
      span.id      = `${pref}-star-${i}`;
      span.className = 'star empty';
      span.textContent = '☆';
      document
        .getElementById(i < 5 ? `${pref}-row1` : `${pref}-row2`)
        .appendChild(span);
    }
  }

  function updateDisplay (pref, total = 0) {
    const filled = total % 10;
    const cards  = Math.floor(total / 10);
    for (let i = 0; i < 10; i++) {
      const el = document.getElementById(`${pref}-star-${i}`);
      if (i < filled) {
        el.textContent = '★';
        el.className   = 'star filled';
      } else {
        el.textContent = '☆';
        el.className   = 'star empty';
      }
    }
    document.getElementById(`${pref}-cards`).textContent = cards;
  }

  /* ---------- db helpers ---------- */
  async function load (pref, column) {
    const { data, error } = await supabase
      .from(TABLE)
      .select(column)
      .eq('id', ROW_ID)
      .single();

    if (!error) updateDisplay(pref, data[column] ?? 0);
  }

  async function addOne (pref, column) {
    /* primeiro le o valor atual */
    const { data: current, error } = await supabase
      .from(TABLE)
      .select(column)
      .eq('id', ROW_ID)
      .single();

    if (error) return console.error(error);

    const newValue = (current[column] ?? 0) + 1;

    /* grava +1 */
    const { error: upErr } = await supabase
      .from(TABLE)
      .update({ [column]: newValue })
      .eq('id', ROW_ID);

    if (!upErr) updateDisplay(pref, newValue);
  }

  /* ---------- init ---------- */
  cards.forEach(({ prefix, column }) => {
    buildStars(prefix);
    load(prefix, column);

    /* clique no botão */
    document
      .getElementById(`${prefix}-starButton`)
      .addEventListener('click', () => addOne(prefix, column));

    /* realtime – atualiza só o card afetado */
    supabase
      .channel(`stars_${prefix}`)
      .on(
        'postgres_changes',
        { event: 'UPDATE', schema: 'public', table: TABLE, filter: `id=eq.${ROW_ID}` },
        payload => updateDisplay(prefix, payload.new[column])
      )
      .subscribe();
  });
</script>
</body>
</html>
